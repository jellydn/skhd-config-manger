# Release Workflow
# Automatically builds and publishes GitHub releases when version tags are pushed
# Reference: specs/004-ci-cd-design/contracts/release.yml

name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on v1.0.0, v1.0.0-alpha.1, v2.1.3, etc.

permissions:
  contents: write  # Required for creating GitHub releases

jobs:
  publish:
    runs-on: macos-latest

    steps:
      # Step 1: Checkout repository with full history for changelog
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for changelog generation

      # Step 2: Setup Bun (JavaScript package manager)
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      # Step 2.5: Cache Bun dependencies
      - name: Cache Bun dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('bun.lockb') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      # Step 3: Setup Rust with universal binary targets
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      # Step 3.5: Cache Rust dependencies
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      # Step 4: Install project dependencies
      - name: Install dependencies
        run: bun install

      # Step 5: Generate changelog from commits
      - name: Generate Changelog
        id: changelog
        run: |
          # Get current tag (the one that triggered this workflow)
          CURRENT_TAG="${{ github.ref_name }}"

          # Get previous stable release tag (exclude test tags and current tag)
          PREV_TAG=$(git tag --sort=-version:refname | grep -v "test" | grep -v "^${CURRENT_TAG}$" | head -1)

          if [ -z "$PREV_TAG" ]; then
            # First release - get all commits
            echo "ðŸ“ First release - generating full changelog"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            # Get commits since previous tag
            echo "ðŸ“ Generating changelog from ${PREV_TAG} to ${CURRENT_TAG}"
            CHANGELOG=$(git log ${PREV_TAG}..${CURRENT_TAG} --pretty=format:"- %s (%h)" --no-merges)

            # Add comparison link for context
            REPO="${{ github.repository }}"
            echo "ðŸ”— Full comparison: https://github.com/${REPO}/compare/${PREV_TAG}...${CURRENT_TAG}"
          fi

          # Filter out noise commits
          CHANGELOG=$(echo "$CHANGELOG" | grep -v "chore: bump version to" || true)

          # If changelog is empty after filtering, add a note
          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="- Version bump release (no feature changes)"
          fi

          # Count changes
          NUM_COMMITS=$(echo "$CHANGELOG" | wc -l | tr -d ' ')
          echo "ðŸ“Š Found ${NUM_COMMITS} changes"

          # Save to file and output
          echo "$CHANGELOG" > /tmp/changelog.txt

          # Create multiline output for GitHub Actions
          {
            echo 'CHANGELOG<<EOF'
            echo "$CHANGELOG"
            echo 'EOF'
          } >> $GITHUB_OUTPUT

      # Step 6: Build and create GitHub release
      - name: Build and Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'Keybinder ${{ github.ref_name }}'
          releaseBody: |
            ## What's Changed

            ${{ steps.changelog.outputs.CHANGELOG }}

            **Full Changelog**: https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}

            ## Installation

            1. Download the DMG file below (`keybinder_*_universal_darwin.dmg`)
            2. Open the DMG file
            3. Drag Keybinder.app to your Applications folder
            4. Launch from Applications or Spotlight (âŒ˜+Space, type "Keybinder")

            ### First Launch (macOS Security)

            macOS may block the app on first launch. To open it:
            1. Control-click (or right-click) the app
            2. Select "Open" from the menu
            3. Click "Open" in the dialog

            Or run: `xattr -cr /Applications/Keybinder.app`

            ## System Requirements

            - macOS 11 (Big Sur) or later
            - Universal binary (works on both Intel and Apple Silicon Macs)

            ---
            ðŸ¤– Built with [Tauri](https://tauri.app)
          releaseDraft: false
          prerelease: false  # GitHub auto-detects from tag format
          args: --target universal-apple-darwin --bundles dmg
