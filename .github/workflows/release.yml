# Release Workflow
# Automatically builds and publishes GitHub releases when version tags are pushed
# Reference: specs/004-ci-cd-design/contracts/release.yml

name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on v1.0.0, v1.0.0-alpha.1, v2.1.3, etc.

permissions:
  contents: write  # Required for creating GitHub releases

jobs:
  publish:
    runs-on: macos-latest

    steps:
      # Step 1: Checkout repository
      - name: Checkout code
        uses: actions/checkout@v4

      # Step 2: Setup Bun (JavaScript package manager)
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      # Step 3: Setup Rust with universal binary targets
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-darwin, x86_64-apple-darwin

      # Step 4: Install project dependencies
      - name: Install dependencies
        run: bun install

      # Step 5: Build and create GitHub release
      - name: Build and Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: 'skhd-gui ${{ github.ref_name }}'
          releaseBody: |
            ## What's Changed
            See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/CHANGELOG.md) for detailed changes.

            ## Installation
            1. Download the DMG file below
            2. Open the DMG
            3. Drag skhd-gui to your Applications folder
            4. Launch from Applications or Spotlight

            ## System Requirements
            - macOS 11 (Big Sur) or later
            - Works on both Intel and Apple Silicon Macs

            ---
            ðŸ¤– Built with [Tauri](https://tauri.app)
          releaseDraft: false
          prerelease: false  # GitHub auto-detects from tag format
          args: --target universal-apple-darwin --bundles dmg
