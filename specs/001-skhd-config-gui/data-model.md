# Data Model: skhd Configuration GUI

**Feature**: 001-skhd-config-gui
**Created**: 2025-11-01
**Purpose**: Define data structures and their relationships

## Core Entities

### 1. Keyboard Shortcut

Represents a single skhd configuration entry mapping a key combination to a shell command.

**Fields**:

- `id`: Unique identifier (UUID) - Generated by application for tracking during editing
- `modifiers`: List of modifier keys (cmd, alt, shift, ctrl, fn) - Order-independent
- `key`: Primary key (string) - The main key being pressed (e.g., "return", "f", "1")
- `command`: Shell command (string) - The command to execute when shortcut is triggered
- `mode`: Optional mode name (string) - For modal shortcuts (e.g., "resize")
- `comment`: Optional comment (string) - Inline comment from config file
- `line_number`: Original line number (integer) - For error reporting and preserving order

**Validation Rules**:

- At least one of (modifiers, key) must be specified
- Command must not be empty or only whitespace
- Key must be a valid keyboard key recognized by skhd
- Modifiers must be from allowed set: {cmd, alt, shift, ctrl, fn}
- No duplicate (modifiers + key) combinations within same mode
- Mode name (if present) must match pattern: /^[a-zA-Z0-9_]+$/

**State Transitions**:

1. `Created` → User adds new shortcut via UI
2. `Modified` → User edits existing shortcut
3. `Deleted` → User removes shortcut (soft delete until save)
4. `Saved` → Changes persisted to config file

**Example**:

```json
{
  "id": "550e8400-e29b-41d4-a716-446655440000",
  "modifiers": ["cmd", "shift"],
  "key": "f",
  "command": "open ~",
  "mode": null,
  "comment": "Open home directory in Finder",
  "line_number": 12
}
```

---

### 2. Configuration File

Represents the complete skhd configuration file with all shortcuts and metadata.

**Fields**:

- `file_path`: Absolute path to config file (string) - Default: `~/.config/skhd/skhdrc`
- `shortcuts`: List of Keyboard Shortcuts - Ordered by line number
- `global_comments`: List of comment lines (string) - Comments not associated with shortcuts
- `last_modified`: Timestamp (ISO 8601 string) - Last modification time from filesystem
- `is_modified`: Boolean - Whether current in-memory state differs from file
- `backup_path`: Optional path to latest backup (string) - Set after save operation
- `parse_errors`: List of ParseError objects - Any errors encountered during parsing

**Validation Rules**:

- File path must exist or be creatable (parent directory must exist)
- No duplicate shortcuts (enforced by Keyboard Shortcut validation)
- All shortcuts must pass individual validation
- File must be readable (permissions check)

**State Transitions**:

1. `Loaded` → File read from disk and parsed successfully
2. `Modified` → In-memory shortcuts differ from file (is_modified = true)
3. `Saved` → In-memory state written to disk (backup created first)
4. `Reloaded` → External changes detected, file re-read
5. `ParseError` → File exists but couldn't be parsed (parse_errors populated)

**Example**:

```json
{
  "file_path": "/Users/username/.config/skhd/skhdrc",
  "shortcuts": [
    /* array of Keyboard Shortcut objects */
  ],
  "global_comments": ["# skhd configuration file", "# Generated by skhd-gui"],
  "last_modified": "2025-11-01T14:30:22Z",
  "is_modified": false,
  "backup_path": "/Users/username/.config/skhd/skhdrc.backup.2025-11-01-143022",
  "parse_errors": []
}
```

---

### 3. Key Combination

Represents a specific keyboard input pattern (composite value object).

**Fields**:

- `modifiers`: Set of modifier keys (cmd, alt, shift, ctrl, fn) - Unordered, unique
- `key`: Primary key (string) - The main key

**Validation Rules**:

- Modifiers must be from allowed set (no duplicates enforced by Set type)
- Key must not be empty
- Key must be valid skhd key identifier

**Comparison**:

- Two KeyCombinations are equal if they have the same modifiers (order-independent) and key
- Used for duplicate detection

**String Representation** (for display):

- Format: `modifier1 + modifier2 - key`
- Modifiers sorted alphabetically for consistency
- Example: `cmd + shift - f`

**Example**:

```json
{
  "modifiers": ["cmd", "shift"],
  "key": "f"
}
```

---

### 4. Backup

Represents a timestamped backup of the configuration file.

**Fields**:

- `original_path`: Path to original config file (string)
- `backup_path`: Path to backup file (string) - Format: `{original}.backup.{timestamp}`
- `created_at`: Timestamp (ISO 8601 string) - When backup was created
- `file_size`: Size in bytes (integer) - For verification
- `checksum`: SHA-256 hash (string) - For integrity verification

**Validation Rules**:

- Backup file must exist and be readable
- Checksum must match file contents
- Created timestamp must not be in the future

**Naming Convention**:

- Format: `skhdrc.backup.YYYY-MM-DD-HHmmss`
- Example: `skhdrc.backup.2025-11-01-143022`
- Ensures chronological sorting and uniqueness

**Example**:

```json
{
  "original_path": "/Users/username/.config/skhd/skhdrc",
  "backup_path": "/Users/username/.config/skhd/skhdrc.backup.2025-11-01-143022",
  "created_at": "2025-11-01T14:30:22Z",
  "file_size": 2048,
  "checksum": "a665a45920422f9d417e4867efdc4fb8a04a1f3fff1fa07e998e86f7f7a27ae3"
}
```

---

### 5. Parse Error

Represents a syntax error encountered while parsing the configuration file.

**Fields**:

- `line_number`: Line number where error occurred (integer)
- `column`: Column number (integer) - Optional, for precise error location
- `error_type`: Error category (enum) - See Error Types below
- `message`: Human-readable error message (string)
- `line_content`: The actual line content (string) - For context in error display

**Error Types** (enum):

- `InvalidModifier` - Unrecognized modifier key
- `InvalidKey` - Unrecognized primary key
- `MissingCommand` - No command specified after ':'
- `InvalidSyntax` - Malformed line structure
- `DuplicateShortcut` - Shortcut already defined
- `InvalidMode` - Mode syntax error

**Example**:

```json
{
  "line_number": 15,
  "column": 8,
  "error_type": "InvalidModifier",
  "message": "Unknown modifier 'command'. Did you mean 'cmd'?",
  "line_content": "command - f : open ~"
}
```

---

## Entity Relationships

```
Configuration File (1)
    │
    ├──> Shortcuts (0..n)
    │       │
    │       └──> Key Combination (1)
    │
    ├──> Parse Errors (0..n)
    │
    └──> Backup (0..1) [latest backup reference]
```

**Relationship Details**:

1. **Configuration File → Keyboard Shortcuts** (One-to-Many)
   - A configuration file contains zero or more shortcuts
   - Shortcuts are ordered by line_number for serialization
   - When shortcut is deleted, it's removed from the list (hard delete in memory, soft until save)

2. **Keyboard Shortcut → Key Combination** (One-to-One)
   - Each shortcut has exactly one key combination (modifiers + key)
   - Key combination is a value object (no independent existence)

3. **Configuration File → Parse Errors** (One-to-Many)
   - If parsing fails, configuration may have errors but still load partial data
   - Empty array if no errors
   - Errors are informational only (don't prevent loading)

4. **Configuration File → Backup** (One-to-One, Optional)
   - Reference to most recent backup after save operation
   - Used for "Restore from Backup" feature (future enhancement)

---

## Data Flow

### Load Configuration

```
1. User launches app
2. Read file from ~/.config/skhd/skhdrc
3. Parse file content using pest grammar
4. Create Keyboard Shortcut objects from parse tree
5. Detect any Parse Errors
6. Create Configuration File object
7. Send to frontend for display
```

### Add Shortcut

```
1. User clicks "Add Shortcut" in UI
2. Frontend creates new Keyboard Shortcut with temporary ID
3. User fills in modifiers, key, command
4. Frontend validates (check for duplicates via key combination comparison)
5. If valid, add to Configuration File shortcuts list
6. Mark Configuration File as modified (is_modified = true)
7. Update UI
```

### Save Configuration

```
1. User clicks "Save"
2. Validate all shortcuts in Configuration File
3. Create Backup object and write current file to backup location
4. Serialize Configuration File to skhd syntax format
5. Write to temporary file
6. Validate temporary file by re-parsing
7. If valid, atomic rename to target file
8. Update Configuration File metadata (last_modified, backup_path, is_modified = false)
9. Notify UI of success
```

### Undo/Redo

```
1. Maintain undo stack (list of Configuration File snapshots)
2. On any modification, push current state to stack
3. On undo, pop from stack and restore previous state
4. On redo, push current to redo stack and restore forward state
5. Clear redo stack on new modification
6. Limit stack size to 50 operations (memory management)
```

---

## Serialization Formats

### skhd Config File Format (Plain Text)

```
# Comment line
modifier1 + modifier2 - key : command

# Example:
cmd - return : open -a Terminal
cmd + shift - f : open ~
alt - h : yabai -m window --focus west
```

### JSON (Internal API / Frontend-Backend Communication)

```json
{
  "shortcuts": [
    {
      "id": "uuid",
      "modifiers": ["cmd"],
      "key": "return",
      "command": "open -a Terminal",
      "mode": null,
      "comment": null,
      "line_number": 2
    }
  ],
  "global_comments": ["# Comment line"],
  "file_path": "/Users/username/.config/skhd/skhdrc",
  "last_modified": "2025-11-01T14:30:22Z",
  "is_modified": false,
  "backup_path": null,
  "parse_errors": []
}
```

---

## Invariants

1. **No Duplicate Shortcuts**: Within a given mode (or global scope), no two shortcuts can have the same key combination
2. **Atomic Saves**: Configuration file is never partially written (all-or-nothing)
3. **Backup Before Save**: Every save operation creates a backup first (even if backup fails, original save aborts)
4. **Valid Syntax**: Only syntactically valid configuration is written to file
5. **Order Preservation**: Shortcuts maintain their original order from file (via line_number)
6. **Comment Preservation**: Comments are preserved during edit cycles where possible

---

## Performance Considerations

**In-Memory Representation**:

- Configuration File: ~1-5 KB for typical config (50-100 shortcuts)
- Single Shortcut: ~200-500 bytes
- Undo stack (50 operations): ~50-250 KB
- Total memory: <1 MB for typical usage

**Parse Performance**:

- Target: <100ms for 1000 lines (per Constitution IV)
- pest parser is O(n) for grammar complexity
- Typical config (100 lines): <10ms expected

**Save Performance**:

- Target: <500ms for full save cycle (backup + validate + write)
- Atomic rename: O(1) operation
- Bottleneck: Disk I/O, not computation
